# This file was autogenerated by actions.nix. Do not edit it manually.
# To make changes, edit the workflow definition in your flake's actions-nix configuration
# (typically under flake.actions-nix.workflows.".github/workflows/ci.yaml") and run:
#   nix run .#render-workflows
# Or commit to trigger the pre-commit hook if enabled.
concurrency:
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
  group: ci-${{ github.head_ref || github.ref_name }}
jobs:
  build:
    name: Build ${{ matrix.attrs.hostname }} (${{ matrix.attrs.hostPlatform }})
    runs-on: ${{ matrix.attrs.runsOn }}
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Purge non-Nix files
      uses: wimpysworld/nothing-but-nix@687c797a730352432950c707ab493fcc951818d7
      with:
        hatchet-protocol: rampage
    - name: Install Nix
      uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd
      with:
        extra_nix_config: |-
          accept-flake-config = true
          always-allow-substitutes = true
          builders-use-substitutes = true
          max-jobs = auto
        github_access_token: ${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1
      with:
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        extraPullNames: nix-community
        name: som3cache
    - name: Remove unbuildable files
      run: rm -f modules/vmware.nix modules/school/cisco.nix
    - env:
        CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
      name: Fast nix build
      run: |-
        nix run nixpkgs#nix-fast-build -- \
          --no-nom \
          --skip-cached \
          --retries=3 \
          --cachix-cache som3cache \
          --option accept-flake-config true \
          --flake="git+file:.#${{ matrix.attrs.output }}"
    strategy:
      fail-fast: false
      matrix:
        attrs:
        - hostPlatform: x86_64-linux
          hostname: athenas
          output: nixosConfigurations.athenas.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: x86_64-linux
          hostname: pandora
          output: nixosConfigurations.pandora.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: x86_64-linux
          hostname: promethea
          output: nixosConfigurations.promethea.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: x86_64-linux
          hostname: sanctuary
          output: nixosConfigurations.sanctuary.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: aarch64-linux
          hostname: xylourgos
          output: nixosConfigurations.xylourgos.config.system.build.toplevel
          runsOn: ubuntu-24.04-arm
  check:
    if: always()
    name: All checks
    needs:
    - flake-check
    - build
    runs-on: ubuntu-latest
    steps:
    - uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      with:
        jobs: ${{ toJSON(needs) }}
  flake-check:
    name: Flake check (${{ matrix.systems.hostPlatform }})
    runs-on: ${{ matrix.systems.runsOn }}
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Purge non-Nix files
      uses: wimpysworld/nothing-but-nix@687c797a730352432950c707ab493fcc951818d7
      with:
        hatchet-protocol: rampage
    - name: Install Nix
      uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd
      with:
        extra_nix_config: |-
          accept-flake-config = true
          always-allow-substitutes = true
          builders-use-substitutes = true
          max-jobs = auto
        github_access_token: ${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1
      with:
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        extraPullNames: nix-community
        name: som3cache
    - name: nix flake check
      run: nix flake check 'git+file:.'
    - name: nix flake show
      run: nix flake show 'git+file:.'
    strategy:
      fail-fast: false
      matrix:
        systems:
        - hostPlatform: x86_64-linux
          runsOn: ubuntu-latest
        - hostPlatform: aarch64-linux
          runsOn: ubuntu-24.04-arm
name: CI
'on':
  pull_request: {}
  push:
    branches:
    - main
    - testing-*
  workflow_dispatch: {}
