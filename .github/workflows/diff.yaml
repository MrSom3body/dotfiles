# This file was autogenerated by actions.nix. Do not edit it manually.
# To make changes, edit the workflow definition in your flake's actions-nix configuration
# (typically under flake.actions-nix.workflows.".github/workflows/diff.yaml") and run:
#   nix run .#render-workflows
# Or commit to trigger the pre-commit hook if enabled.
concurrency:
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
  group: diff-${{ github.head_ref || github.ref_name }}
jobs:
  generate-diffs:
    name: Generate Diff (${{ matrix.attrs.hostname}})
    permissions:
      contents: read
    runs-on: ${{ matrix.attrs.runsOn }}
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Purge non-Nix files
      uses: wimpysworld/nothing-but-nix@687c797a730352432950c707ab493fcc951818d7
      with:
        hatchet-protocol: rampage
    - name: Install Nix
      uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd
      with:
        github_access_token: ${{ secrets.GITHUB_TOKEN }}
    - name: Setup Nix cache
      uses: nix-community/cache-nix-action@7df957e333c1e5da7721f60227dbba6d06080569
      with:
        gc-max-store-size-linux: 5G
        primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock')
          }}
        purge: true
        purge-created: 0
        purge-last-accessed: 0
        purge-prefixes: nix-${{ runner.os }}-
        purge-primary-key: never
        restore-prefixes-first-match: nix-${{ runner.os }}-
    - name: Remove unbuildable modules
      run: |-
        rm -f \
          modules/vmware.nix \
          modules/school/cisco.nix
    - name: Generate diff (${{ matrix.attrs.hostname }})
      uses: natsukium/nix-diff-action@374bf5037dc84fc520da2002beef2f2bd96f4e9b
      with:
        attributes: |-
          - displayName: ${{ matrix.attrs.hostname }}
            attribute: ${{ matrix.attrs.output }}
        mode: diff-only
    strategy:
      fail-fast: false
      matrix:
        attrs:
        - hostPlatform: x86_64-linux
          hostname: athenas
          output: nixosConfigurations.athenas.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: x86_64-linux
          hostname: pandora
          output: nixosConfigurations.pandora.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: x86_64-linux
          hostname: promethea
          output: nixosConfigurations.promethea.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: x86_64-linux
          hostname: sanctuary
          output: nixosConfigurations.sanctuary.config.system.build.toplevel
          runsOn: ubuntu-latest
        - hostPlatform: aarch64-linux
          hostname: xylourgos
          output: nixosConfigurations.xylourgos.config.system.build.toplevel
          runsOn: ubuntu-24.04-arm
    timeout-minutes: 60
  post-diff-comment:
    name: Post comment
    needs:
    - generate-diffs
    permissions:
      actions: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Post diff comment
      uses: natsukium/nix-diff-action@374bf5037dc84fc520da2002beef2f2bd96f4e9b
      with:
        mode: comment-only
    timeout-minutes: 60
name: Diff
'on':
  pull_request: {}
  workflow_dispatch: {}
