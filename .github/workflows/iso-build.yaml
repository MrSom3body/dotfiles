# This file was autogenerated by actions.nix. Do not edit it manually.
# To make changes, edit the workflow definition in your flake's actions-nix configuration
# (typically under flake.actions-nix.workflows.".github/workflows/iso-build.yaml") and run:
#   nix run .#render-workflows
# Or commit to trigger the pre-commit hook if enabled.
jobs:
  build-images:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Purge non-Nix files
      uses: wimpysworld/nothing-but-nix@687c797a730352432950c707ab493fcc951818d7
      with:
        hatchet-protocol: rampage
    - name: Install Nix
      uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd
      with:
        extra_nix_config: |-
          accept-flake-config = true
          always-allow-substitutes = true
          builders-use-substitutes = true
          max-jobs = auto
        github_access_token: ${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1
      with:
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        extraPullNames: nix-community
        name: som3cache
    - env:
        CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
      name: Nix build
      run: |-
        nix develop --command -- nix-fast-build \
          --no-nom \
          --skip-cached \
          --retries=3 \
          --cachix-cache som3cache \
          --option accept-flake-config true \
          --flake="git+file:.#images.${{ matrix.image }}"
    - name: Upload artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: ${{ matrix.image }}-iso-image
        path: result-*/iso/*.iso
    strategy:
      matrix:
        image:
        - sanctuary
  publish-images:
    needs:
    - build-images
    runs-on: ubuntu-latest
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      with:
        merge-multiple: true
    - id: get-date
      name: Generate date
      run: echo "date=$(date +'%Y-%m-%d-%H%M%S')" >> "${GITHUB_OUTPUT}"
    - name: Generate checksums
      run: sha256sum *.iso > checksums.txt
    - name: Create release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
      with:
        body: "> [!CAUTION]\n> These ISOs have my public keys added. This means I\
          \ can SSH into them without any password.\n\nThese ISOs are built straight\
          \ from my NixOS configs in [MrSom3body/dotfiles](https://github.com/MrSom3body/dotfiles)\
          \ and meant **only** for me to be able to just plug these in and run `nixos-anywhere`.\n\
          \n## \U0001F4E6 What\u2019s inside\n\n| Image         | Purpose        \
          \                              |\n| ------------- | --------------------------------------------\
          \ |\n| **sanctuary** | ISO to install NixOS with my public SSH keys |\n\n\
          ## \U0001F512 Verify checksum\n\n```bash\nsha256sum -c checksums.txt\n```"
        files: |-
          *.iso
          checksums.txt
        name: "\U0001F6E0  Weekly ISO Release \u2014 ${{ steps.get-date.outputs.date\
          \ }}"
        tag_name: iso-${{ steps.get-date.outputs.date }}
name: ISO Build
'on':
  schedule:
  - cron: 0 0 * * mon
  workflow_dispatch: {}
