# This file was autogenerated by actions.nix. Do not edit it manually.
# To make changes, edit the workflow definition in your flake's actions-nix configuration
# (typically under flake.actions-nix.workflows.".github/workflows/topology-update.yaml") and run:
#   nix run .#render-workflows
# Or commit to trigger the pre-commit hook if enabled.
jobs:
  update-topology:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Purge non-Nix files
      uses: wimpysworld/nothing-but-nix@687c797a730352432950c707ab493fcc951818d7
      with:
        hatchet-protocol: rampage
    - name: Install Nix
      uses: cachix/install-nix-action@2126ae7fc54c9df00dd18f7f18754393182c73cd
      with:
        extra_nix_config: |-
          accept-flake-config = true
          always-allow-substitutes = true
          builders-use-substitutes = true
          max-jobs = auto
        github_access_token: ${{ secrets.GITHUB_TOKEN }}
    - name: Setup Cachix
      uses: cachix/cachix-action@3ba601ff5bbb07c7220846facfa2cd81eeee15a1
      with:
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        extraPullNames: nix-community
        name: som3cache
    - id: app-token
      name: Generate App Token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}
    - name: Build topology
      run: nix build .#topology.x86_64-linux.config.output
    - name: Generate WebP
      run: nix run nixpkgs#librsvg -- -o .github/assets/topology.webp ./result/main.svg
    - id: create-pr
      name: Create PR
      uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0
      with:
        body: This PR updates the network topology image generated from the latest
          Nix configuration.
        commit-message: 'assets: update topology image'
        delete-branch: true
        labels: automated
        title: 'assets: update topology image'
        token: ${{ steps.app-token.outputs.token }}
    - env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}
      name: Auto Merge PR (${{ steps.create-pr.outputs.pull-request-number }})
      run: |-
        if [ -n "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
          gh pr merge --auto --rebase ${{ steps.create-pr.outputs.pull-request-number }}
        fi
name: Topology Update
'on':
  schedule:
  - cron: 0 0 1,15 * *
  workflow_dispatch: {}
